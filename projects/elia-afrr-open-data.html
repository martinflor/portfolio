<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ELIA Open Data ‚Äî aFRR Capacity Backtesting (Price‚ÄìVolume Replay)</title>

  <!-- Your global site styles -->
  <link rel="stylesheet" href="../assets/css/style.css" />
  <script src="../assets/js/theme.js"></script>

  <!-- Post-specific styling -->
  <style>
    .post-header { margin-top: 22px; }
    .post-meta { opacity: 0.78; font-size: 14px; margin-top: 6px; }
    .toc { margin-top: 14px; }
    .toc a { border-bottom: 1px dashed rgba(185,2,9,0.55); }
    .toc a:hover { border-bottom-style: solid; text-decoration: none; }

    .post { margin-top: 18px; padding: 18px; }
    .post h2 { margin-top: 18px; }
    .post h3 { margin-top: 14px; font-size: 17px; }

    .note {
      border: 1px solid rgba(185,2,9,0.28);
      background: linear-gradient(180deg, rgba(185,2,9,0.10), rgba(185,2,9,0.03));
      border-radius: 12px;
      padding: 12px;
      margin: 14px 0;
    }
    .note .label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 6px;
    }
    .note p { margin: 0; opacity: 0.92; }

    figure {
      margin: 16px 0;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.03);
    }
    figure img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 10px;
      border: 1px solid var(--card-border);
    }
    figcaption {
      margin-top: 10px;
      font-size: 13px;
      opacity: 0.78;
      line-height: 1.5;
    }

    code.inline {
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.04);
      font-size: 0.95em;
    }

    .pillrow {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top: 10px;
    }
    .pill {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 10px;
      border-radius:999px;
      border:1px solid var(--card-border);
      background: rgba(255,255,255,0.04);
      font-size: 13px;
      line-height: 1;
    }
    .pill::before{
      content:"";
      width:8px;
      height:8px;
      border-radius:3px;
      background: var(--accent);
      display:inline-block;
      opacity:0.95;
    }

    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 860px){
      .two-col { grid-template-columns: 1fr; }
    }

    /* === UP/DOWN per-figure toggle === */
    .fig-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .seg{
      display:inline-flex;
      border:1px solid var(--card-border);
      border-radius:999px;
      overflow:hidden;
      background: rgba(255,255,255,0.03);
    }
    .seg button{
      appearance:none;
      border:0;
      background:transparent;
      color: var(--text);
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
    }
    .seg button + button{
      border-left:1px solid var(--card-border);
    }
    .seg button.active{
      background: rgba(185,2,9,0.14);
      font-weight:700;
    }
    .seg button:hover{
      background: rgba(185,2,9,0.10);
    }

    /* Schema block */
    .schema {
      border: 1px solid var(--card-border);
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      padding: 12px;
      margin: 16px 0;
    }
    .schema .kicker { margin-bottom: 8px; display:block; }
    .schema svg {
      width: 100%;
      height: auto;
      display:block;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.02);
    }
    .schema .caption {
      margin-top: 10px;
      font-size: 13px;
      opacity: 0.78;
      line-height: 1.5;
    }
  </style>

  <!-- MathJax (easy LaTeX editing) -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['\\(','\\)'], ['$', '$']],
        displayMath: [['\\[','\\]'], ['$$','$$']]
      },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>

<body>
  <div class="container">
    <!-- Navbar -->
    <header class="nav">
      <div class="brand">
        <span class="dot"></span>
        <span>Your Name</span>
      </div>

      <nav class="navlinks">
        <a href="../index.html">About</a>
        <a href="../projects.html" class="active">Projects / Blog</a>
      </nav>

      <div class="actions">
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle night mode" title="Toggle night mode">
          <span class="icon" aria-hidden="true"></span>
        </button>
      </div>
    </header>

    <!-- Post header -->
    <section class="post-header">
      <div class="kicker">Project / Blog</div>
      <h1>aFRR Capacity Backtesting (ELIA Open Data)</h1>
      <div class="post-meta">
        A price‚Äìvolume replay model to backtest capacity bidding strategies across historical 4-hour blocks.
      </div>

      <div class="pillrow">
        <span class="pill">Energy Markets</span>
        <span class="pill">aFRR</span>
        <span class="pill">Pay-as-bid</span>
        <span class="pill">Decision Support</span>
        <span class="pill">Python</span>
      </div>

      <div class="toc card">
        <div class="kicker">Contents</div>
        <p style="margin:10px 0 0;">
          <a href="#market">1) The aFRR capacity market</a> ¬∑
          <a href="#intuition">2) Merit order intuition</a> ¬∑
          <a href="#data">3) Data sources</a> ¬∑
          <a href="#model">4) Price‚Äìvolume replay model</a> ¬∑
          <a href="#backtest">5) Backtesting across blocks</a> ¬∑
          <a href="#recommend">6) Using historical data to guide bids</a> ¬∑
          <a href="#limits">7) Limitations & next steps</a> ¬∑
          <a href="#app">Try it yourself</a>
        </p>
      </div>
    </section>

    <!-- Post body -->
    <article class="card post">
      <h2 id="market">1) What is the aFRR capacity market?</h2>
      <p>
        The <span class="emph">automatic Frequency Restoration Reserve (aFRR)</span> capacity market pays flexible assets
        to remain available for real-time balancing. From a participant perspective, the aFRR <span class="emph">capacity</span>
        auction answers one question:
      </p>
      <p>
        <span class="emph">How much flexibility do I commit in advance, and at what price?</span>
      </p>

      <div class="two-col">
        <div class="item">
          <h3>Product & timing</h3>
          <ul style="margin: 0; padding-left: 18px; line-height: 1.7;">
            <li>Separate products: <span class="emph">UP</span> and <span class="emph">DOWN</span></li>
            <li>Cleared per <span class="emph">4-hour block</span> (00‚Äì04, 04‚Äì08, ‚Ä¶, 20‚Äì24)</li>
            <li>Each block is independent</li>
          </ul>
        </div>
        <div class="item">
          <h3>Bid variables</h3>
          <ul style="margin: 0; padding-left: 18px; line-height: 1.7;">
            <li>Bid price \(p\) in ‚Ç¨/MW/h</li>
            <li>Bid volume \(q\) in MW</li>
            <li>Award can be <span class="emph">full</span> or <span class="emph">partial</span></li>
          </ul>
        </div>
      </div>

      <div class="note" id="payasbid">
        <div class="label">Key rule</div>
        <p>
          aFRR capacity is <span class="emph">pay-as-bid</span>: if your bid is accepted, you are paid at <span class="emph">your own</span>
          bid price \(p\), not a single market-clearing price. This is why acceptance dynamics matter as much as prices.
        </p>
      </div>

      <h2 id="intuition">2) Merit order intuition</h2>
      <p>
        For each block, the market forms a <span class="emph">merit order</span> (price ascending). Volumes are stacked until
        the required capacity is reached. Your slides illustrate this with a simple ‚Äúwhat if I add my bid?‚Äù view.
      </p>

      <div class="two-col">
        <div class="item">
          <h3>Case A ‚Äî Out of the merit order</h3>
          <p>
            If cheaper bids already cover the required volume, a high bid (e.g., 40 ‚Ç¨/MW/h) is likely rejected.
            You earn 0 ‚Ç¨, and might be priced out unnecessarily.
          </p>
        </div>
        <div class="item">
          <h3>Case B ‚Äî In the merit order</h3>
          <p>
            If your bid is below the last accepted level, you can be fully or partially awarded.
            Under pay-as-bid, you are paid at <span class="emph">your price</span>.
          </p>
        </div>
      </div>

      <p style="margin-top: 10px;">
        The practical question becomes:
        <span class="emph">‚ÄúAt which price do I enter the merit order, and how reliably?‚Äù</span>
      </p>

      <h2 id="data">3) Data sources</h2>
      <p>
        The capacity backtesting in this post is built around ELIA Open Data dataset <code class="inline">ods125</code>
        (capacity prices and awarded volumes). For energy prices (separate topic), ELIA provides
        <code class="inline">ods064</code> (until 2024-05-21) and <code class="inline">ods166</code> (from 2024-05-22).
      </p>

      <h2 id="model">4) The price‚Äìvolume replay model</h2>
      <p>
        This is a <span class="emph">counterfactual replay</span> model:
        it takes a historical auction block, reconstructs the price‚Äìvolume stack, inserts your bid \((p, q)\),
        then recomputes what would have happened.
      </p>

      <!-- Schema block: inline SVG so you don't need an extra image -->
      <div class="schema">
        <span class="kicker">Schema</span>

        <!-- Inline SVG (edit text easily if you want) -->
        <svg viewBox="0 0 1100 420" role="img" aria-label="Price‚Äìvolume replay model schema">
          <defs>
            <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
              <path d="M 0 0 L 10 5 L 0 10 z" fill="currentColor"></path>
            </marker>
          </defs>

          <!-- Background grid feel -->
          <rect x="0" y="0" width="1100" height="420" fill="transparent"></rect>

          <!-- Boxes -->
          <g fill="none" stroke="currentColor" stroke-opacity="0.25" stroke-width="2">
            <rect x="40" y="55" width="290" height="120" rx="16"></rect>
            <rect x="405" y="55" width="290" height="120" rx="16"></rect>
            <rect x="770" y="55" width="290" height="120" rx="16"></rect>

            <rect x="40" y="245" width="360" height="130" rx="16"></rect>
            <rect x="460" y="245" width="600" height="130" rx="16"></rect>
          </g>

          <!-- Accent top bars -->
          <g fill="currentColor" fill-opacity="0.12">
            <rect x="40" y="55" width="290" height="14" rx="8"></rect>
            <rect x="405" y="55" width="290" height="14" rx="8"></rect>
            <rect x="770" y="55" width="290" height="14" rx="8"></rect>
            <rect x="40" y="245" width="360" height="14" rx="8"></rect>
            <rect x="460" y="245" width="600" height="14" rx="8"></rect>
          </g>

          <!-- Text -->
          <g fill="currentColor" fill-opacity="0.92" font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="18">
            <text x="70" y="105" font-weight="700">ELIA Open Data (ods125)</text>
            <text x="70" y="134" font-size="15" fill-opacity="0.75">All bids per 4h block (UP / DOWN)</text>
            <text x="70" y="158" font-size="15" fill-opacity="0.75">Prices + offered/awarded volumes</text>

            <text x="435" y="105" font-weight="700">Build Offer Stack</text>
            <text x="435" y="134" font-size="15" fill-opacity="0.75">Group by price ‚Üí sum volumes</text>
            <text x="435" y="158" font-size="15" fill-opacity="0.75">Sort ‚Üí cumulative volume curve</text>

            <text x="800" y="105" font-weight="700">Insert Your Bid</text>
            <text x="800" y="134" font-size="15" fill-opacity="0.75">Bid price p (‚Ç¨/MW/h)</text>
            <text x="800" y="158" font-size="15" fill-opacity="0.75">Bid volume q (MW)</text>

            <text x="70" y="295" font-weight="700">Replay Clearing</text>
            <text x="70" y="324" font-size="15" fill-opacity="0.75">Check if your bid enters the merit order</text>
            <text x="70" y="348" font-size="15" fill-opacity="0.75">Compute accepted volume (full/partial/none)</text>

            <text x="490" y="295" font-weight="700">Backtest Across Blocks</text>
            <text x="490" y="324" font-size="15" fill-opacity="0.75">Repeat over historical 4h blocks</text>
            <text x="490" y="348" font-size="15" fill-opacity="0.75">Aggregate acceptance, awarded volume, sensitivity by time block</text>
          </g>

          <!-- Arrows -->
          <g stroke="currentColor" stroke-opacity="0.35" stroke-width="3" fill="none" marker-end="url(#arrow)">
            <path d="M 330 115 L 405 115"></path>
            <path d="M 695 115 L 770 115"></path>
            <path d="M 915 175 L 915 245"></path>
            <path d="M 585 175 L 585 245"></path>
            <path d="M 220 175 L 220 245"></path>
            <path d="M 400 310 L 460 310"></path>
          </g>

          <!-- Little legend-like note -->
          <g fill="currentColor" fill-opacity="0.65" font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13">
            <text x="40" y="405">Tip: this is a counterfactual replay (not a forecast).</text>
          </g>
        </svg>

        <div class="caption">
          <span class="emph">Figure S.</span> Price‚Äìvolume replay model: reconstruct the historical offer stack,
          insert your bid \((p,q)\), replay the merit order, then aggregate results across blocks.
          (This mirrors the logic implemented in the Python model.)
        </div>
      </div>

      <h3>Key quantities</h3>
      <p>
        We often use volume-weighted capacity prices to summarize ‚Äúwhat the system effectively paid‚Äù in a block:
      </p>
      <p style="margin-top: 8px;">
        \[
          P_{\text{vw}} = \frac{\sum_i P_i \cdot V_i}{\sum_i V_i}
        \]
      </p>
      <p>
        where \(P_i\) is the awarded capacity price and \(V_i\) the awarded volume.
      </p>

      <figure>
        <img
          src="../assets/img/posts/elia-afrr/vw_capacity_prices_4h.png"
          alt="Volume-weighted aFRR capacity prices (UP and DOWN, 4h step)"
          loading="lazy"
        />
        <figcaption>
          <span class="emph">Figure 1.</span> Volume-weighted aFRR capacity prices (4h step) with both UP & DOWN.
          (Single plot ‚Äî no toggle needed.)
        </figcaption>
      </figure>

      <h2 id="backtest">5) Backtesting across historical blocks</h2>
      <p>
        Once we can replay a single block, we can replay <span class="emph">every historical 4h block</span> with the same bid,
        and summarize outcomes. Conceptually:
      </p>
      <p style="margin-top: 8px;">
        \[
          \text{Backtest}(p,q) \Rightarrow \{\text{full award},\ \text{partial award},\ \text{no award}\} \ \text{over time}
        \]
      </p>
      <p>
        This provides a practical view of risk: how often a given bid would be accepted and how much volume tends to be awarded.
      </p>

      <figure class="toggle-figure"
        data-up="../assets/img/posts/elia-afrr/p_accept_vs_bid_up.png"
        data-down="../assets/img/posts/elia-afrr/p_accept_vs_bid_down.png"
        data-mode="up">

        <div class="fig-head">
          <div class="kicker" style="margin:0;">Acceptance vs bid price</div>
          <div class="seg" role="tablist" aria-label="Toggle UP/DOWN acceptance view">
            <button type="button" class="active" data-set="up" role="tab" aria-selected="true">UP</button>
            <button type="button" data-set="down" role="tab" aria-selected="false">DOWN</button>
          </div>
        </div>

        <img
          src="../assets/img/posts/elia-afrr/p_accept_vs_bid_up.png"
          alt="Acceptance vs bid price (toggle UP/DOWN)"
          loading="lazy"
        />

        <figcaption>
          <span class="emph">Figure 2.</span> Acceptance behavior across price levels, segmented by 4h blocks.
          Toggle to compare UP vs DOWN.
        </figcaption>
      </figure>

      <h2 id="recommend">6) Using historical data to guide bids</h2>
      <p>
        Acceptance is only half the story: bidding very low increases acceptance, but reduces unit value.
        A simple historical decision heuristic is to examine an expected-value proxy:
      </p>

      <p>
        \[
          \text{EV}(p) = p \cdot \mathbb{P}(\text{accept} \mid p, q)
        \]
      </p>

      <p>
        The idea is not to ‚Äúpredict tomorrow‚Äù, but to identify a <span class="emph">baseline price region</span> where
        the trade-off between price and acceptance historically looked reasonable ‚Äî then apply your own risk adjustment.
      </p>

      <figure class="toggle-figure"
        data-up="../assets/img/posts/elia-afrr/bid_times_p_accept_up.png"
        data-down="../assets/img/posts/elia-afrr/bid_times_p_accept_down.png"
        data-mode="up">

        <div class="fig-head">
          <div class="kicker" style="margin:0;">Bid √ó acceptance proxy</div>
          <div class="seg" role="tablist" aria-label="Toggle UP/DOWN expected value proxy">
            <button type="button" class="active" data-set="up" role="tab" aria-selected="true">UP</button>
            <button type="button" data-set="down" role="tab" aria-selected="false">DOWN</button>
          </div>
        </div>

        <img
          src="../assets/img/posts/elia-afrr/bid_times_p_accept_up.png"
          alt="Bid times acceptance proxy (toggle UP/DOWN)"
          loading="lazy"
        />

        <figcaption>
          <span class="emph">Figure 3.</span> A historical proxy \( \text{EV}(p)=p\cdot \mathbb{P}(\text{accept}\mid p,q) \)
          across time blocks. Peaks highlight ‚Äúsweet spots‚Äù. Toggle UP vs DOWN.
        </figcaption>
      </figure>

      <h3>Practical workflow</h3>
      <div class="list">
        <div class="item">
          <h3>1) Choose bid volume \(q\)</h3>
          <p>
            Fix a volume aligned with your asset‚Äôs reliable capability (and how much you want to allocate to aFRR).
          </p>
        </div>
        <div class="item">
          <h3>2) Sweep bid prices \(p\)</h3>
          <p>
            For each price, replay across historical blocks and compute acceptance / awarded volume metrics.
          </p>
        </div>
        <div class="item">
          <h3>3) Pick a baseline and apply risk adjustment</h3>
          <p>
            Select a baseline price region (e.g., near an EV peak), then shift lower for reliability or higher for aggressiveness.
          </p>
        </div>
      </div>

      <h2 id="limits">7) Limitations & next steps</h2>
      <div class="two-col">
        <div class="item">
          <h3>Limitations</h3>
          <ul style="margin:0; padding-left:18px; line-height: 1.7;">
            <li>Historical replay assumes the past is informative.</li>
            <li>Does not explicitly model structural regime changes.</li>
            <li>Counterfactuals ignore strategic response from other participants.</li>
          </ul>
        </div>
        <div class="item">
          <h3>Next steps</h3>
          <ul style="margin:0; padding-left:18px; line-height: 1.7;">
            <li>Condition results on tightness / system indicators.</li>
            <li>Connect energy activation (ods064/ods166) with capacity outcomes.</li>
            <li>Package model as a reproducible notebook + dashboard.</li>
          </ul>
        </div>
      </div>

      <div class="note" id="app" style="margin-top:18px;">
        <div class="label">Try it yourself</div>
        <p>
          I also built a small <span class="emph">Streamlit application</span> where you can test bid price & volume,
          switch UP/DOWN, and inspect outcomes by 4h block.
        </p>
        <p style="margin-top:10px;">
          üëâ <a href="https://YOUR-STREAMLIT-APP-URL" target="_blank" rel="noreferrer">
            Open the interactive aFRR bidding app
          </a>
        </p>
      </div>

      <div class="btnrow" style="margin-top: 16px;">
        <a class="btn primary" href="../projects.html">‚Üê Back to Projects</a>
      </div>
    </article>

    <div class="footer">
      ¬© <span id="year"></span> Your Name ¬∑ aFRR capacity replay model
    </div>
  </div>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>

  <!-- Toggle logic for UP/DOWN figures -->
  <script>
    (function () {
      function setMode(fig, mode) {
        const up = fig.getAttribute("data-up");
        const down = fig.getAttribute("data-down");
        const img = fig.querySelector("img");
        const btnUp = fig.querySelector('button[data-set="up"]');
        const btnDown = fig.querySelector('button[data-set="down"]');

        if (!img || !up || !down) return;

        fig.setAttribute("data-mode", mode);
        img.src = (mode === "down") ? down : up;

        if (btnUp && btnDown) {
          const isDown = mode === "down";
          btnUp.classList.toggle("active", !isDown);
          btnDown.classList.toggle("active", isDown);
          btnUp.setAttribute("aria-selected", String(!isDown));
          btnDown.setAttribute("aria-selected", String(isDown));
        }
      }

      document.querySelectorAll(".toggle-figure").forEach((fig) => {
        setMode(fig, fig.getAttribute("data-mode") || "up");
        fig.querySelectorAll("button[data-set]").forEach((btn) => {
          btn.addEventListener("click", () => setMode(fig, btn.getAttribute("data-set")));
        });
      });
    })();
  </script>
</body>
</html>
